<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">dist/main/externalApis/worldCup.js | potts-reborn</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">dist/main/externalApis/worldCup.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&quot;use strict&quot;;
var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this &amp;&amp; this.__importDefault) || function (mod) {
    return (mod &amp;&amp; mod.__esModule) ? mod : { &quot;default&quot;: mod };
};
var __importStar = (this &amp;&amp; this.__importStar) || function (mod) {
    if (mod &amp;&amp; mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result[&quot;default&quot;] = mod;
    return result;
};
Object.defineProperty(exports, &quot;__esModule&quot;, { value: true });
const core_1 = __importDefault(require(&quot;lodash/core&quot;));
const moji_translate_1 = __importDefault(require(&quot;moji-translate&quot;));
const request_promise_1 = __importDefault(require(&quot;request-promise&quot;));
const string_1 = require(&quot;../utils/string&quot;);
const CacheProvider = __importStar(require(&quot;./node-cache&quot;));
const MAX_COUNTRY_LENGTH = 10;
const MAX_GOALS_LENGTH = 2;
const options = {
    uri: &apos;http://worldcup.sfg.io/matches&apos;,
    headers: {
        &apos;User-Agent&apos;: &apos;Request-Promise&apos;,
    },
    json: true,
};
const rpad = (value, char, length) =&gt; {
    if (typeof value === &apos;undefined&apos;) {
        return undefined;
    }
    return (value + char.repeat(length)).substring(0, length);
};
const isCompletedOrInProgress = (match) =&gt; {
    return match.status === &apos;completed&apos; || match.status === &apos;in progress&apos;;
};
const matchHappeningToday = (match) =&gt; {
    const date = new Date(match.datetime);
    const today = new Date();
    return ((date.getDate() === today.getDate()
        &amp;&amp; date.getMonth() === today.getMonth())
        || (date.getMonth() === today.getMonth()
            &amp;&amp; date.getDate() === today.getDate() + 1
            &amp;&amp; date.getHours() === 2))
        &amp;&amp; (date.getDate() + date.getHours().toString() !== today.getDate() + &apos;2&apos;);
};
const getCountryFlag = (value) =&gt; {
    return moji_translate_1.default.translate(value.replace(/ /g, &apos;_&apos;), true);
};
const toConsoleOutput = (match) =&gt; {
    let homeFlag = getCountryFlag(match.home_team.country);
    if (!homeFlag) {
        homeFlag = &apos;  &apos;;
    }
    const home = string_1.padRight(match.home_team.country, &apos; &apos;, MAX_COUNTRY_LENGTH);
    const homeGoals = rpad(match.home_team.goals, &apos; &apos;, MAX_GOALS_LENGTH) || &apos;&apos;;
    const awayFlag = getCountryFlag(match.away_team.country);
    const away = string_1.padLeft(match.away_team.country, &apos; &apos;, MAX_COUNTRY_LENGTH);
    const awayGoals = rpad(match.away_team.goals, &apos; &apos;, MAX_GOALS_LENGTH) || &apos;&apos;;
    const hours = new Date(match.datetime).getHours();
    const presentableHours = hours &lt; 12 ?
        hours.toString() + &apos;am&apos;
        : (hours - 12).toString() + &apos;pm&apos;;
    return `${homeFlag} ${home} ${homeGoals} -  ${awayGoals} ${away} ${awayFlag} ${presentableHours}`;
};
const getMatches = () =&gt; __awaiter(this, void 0, void 0, function* () {
    try {
        const matches = yield request_promise_1.default(options);
        return matches;
    }
    catch (e) {
        return Promise.reject(e);
    }
});
/**
 * Get the last n matches of specific synchronous filter
 * @param {any} matches
 * @param {any} filter
 * @param {number} n
 */
const synchFilter = (matches, filter, n) =&gt; {
    return new Promise((resolve) =&gt; {
        n = n ? n : 3;
        const temp = matches;
        const result = [];
        temp
            .filter(filter)
            .map(toConsoleOutput)
            .forEach((r) =&gt; result.push(r));
        resolve(result.slice(Math.max(result.length - n, 1)));
    });
};
const getWCSchedule = () =&gt; __awaiter(this, void 0, void 0, function* () {
    try {
        const schedule = yield CacheProvider.get(&apos;WorldCupScheduleToday&apos;);
        if (schedule !== undefined) {
            return schedule;
        }
        else {
            const NO_MATCH_TODAY = &apos;There isn\&apos;t any match today!&apos;;
            const matches = yield getMatches();
            const past = yield synchFilter(matches, isCompletedOrInProgress, 3);
            const present = yield synchFilter(matches, matchHappeningToday, 10);
            let message = &apos;Last 3 matches: \n&apos;;
            if (!core_1.default.isEmpty(past)) {
                for (const match of past) {
                    message += match + &apos;\n&apos;;
                }
            }
            message += &apos;Today matches: \n&apos;;
            if (!core_1.default.isEmpty(present)) {
                for (const match of present) {
                    message += match + &apos;\n&apos;;
                }
            }
            if (!core_1.default.isEmpty(past) || !core_1.default.isEmpty(present)) {
                yield CacheProvider.save(&apos;WorldCupScheduleToday&apos;, message);
                return message;
            }
            else {
                yield CacheProvider.save(&apos;WorldCupScheduleToday&apos;, NO_MATCH_TODAY);
                return NO_MATCH_TODAY;
            }
        }
    }
    catch (e) {
        return Promise.reject(e);
    }
});
exports.default = getWCSchedule;
//# sourceMappingURL=worldCup.js.map</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
