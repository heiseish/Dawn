<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">dist/main/externalApis/rx.js | potts-reborn</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">dist/main/externalApis/rx.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&quot;use strict&quot;;
var __importDefault = (this &amp;&amp; this.__importDefault) || function (mod) {
    return (mod &amp;&amp; mod.__esModule) ? mod : { &quot;default&quot;: mod };
};
Object.defineProperty(exports, &quot;__esModule&quot;, { value: true });
const idx_1 = __importDefault(require(&quot;idx&quot;));
const rxjs_1 = require(&quot;rxjs&quot;);
const logger_1 = __importDefault(require(&quot;../logger&quot;));
const firebasedb_1 = __importDefault(require(&quot;../model/database/firebasedb&quot;));
const account_1 = require(&quot;./../utils/account&quot;);
const _twitter_1 = require(&quot;./@twitter&quot;);
// @messenger
const message_1 = __importDefault(require(&quot;../messenger/api/message&quot;));
const sendImage_1 = __importDefault(require(&quot;../messenger/api/sendImage&quot;));
// @telegram
const api_1 = require(&quot;../telegram/api/&quot;);
const POKEMONGO_TWITTER = &apos;2839430431&apos;;
const WYK_TWITTER = &apos;44680622&apos;;
const MY_TWITTER = &apos;700623960&apos;;
const listOfStreams = [
    POKEMONGO_TWITTER,
    WYK_TWITTER,
    MY_TWITTER,
];
class Streaming {
    constructor(listOfAudience = []) {
        this.listOfAudience = listOfAudience || null;
        if (listOfAudience) {
            const streaming = rxjs_1.Observable.create((observer) =&gt; {
                const twitter = _twitter_1.client.stream(&apos;statuses/filter&apos;, { follow: listOfStreams.join(&apos;,&apos;) });
                twitter.on(&apos;data&apos;, (tweet) =&gt; {
                    if (listOfStreams.includes(tweet.user.id_str)) {
                        observer.next({
                            name: tweet.user.name,
                            text: tweet.text,
                            image: idx_1.default(tweet, (_) =&gt; _.extended_entities.media[0].media_url_https) || null,
                            audience: listOfAudience,
                        });
                    }
                });
                twitter.on(&apos;error&apos;, (error) =&gt; {
                    observer.error(error);
                });
                return () =&gt; {
                    logger_1.default.warn(&apos;Closing twitter stream&apos;);
                };
            });
            this.twitterStreaming = streaming.subscribe({
                next: (x) =&gt; {
                    for (const userId of x.audience) {
                        let message;
                        let image;
                        const { platform, id, } = account_1.getPlatformAndId(userId);
                        if (platform === &apos;messenger&apos;) {
                            message = message_1.default;
                            image = sendImage_1.default;
                            // } else if (platform === &apos;telegram&apos;) {
                        }
                        else {
                            message = api_1.tlgMessage;
                            image = api_1.tlgImage;
                        }
                        message(id, `${x.name}: ${x.text}`);
                        if (x.image) {
                            image(id, x.image);
                        }
                    }
                },
                error: (err) =&gt; logger_1.default.error(&apos;something wrong occurred: &apos; + err),
                complete: () =&gt; logger_1.default.info(&apos;done&apos;),
            });
        }
    }
    stopStreaming() {
        logger_1.default.warn(&apos;Resetting Twitter streaming because of a new stream&apos;);
        this.twitterStreaming.unsubscribe();
    }
    isStreaming() {
        return this.listOfAudience != null;
    }
}
const setUpStreamingApi = () =&gt; {
    let StreamingInstance = new Streaming();
    firebasedb_1.default.database().ref(&apos;restricted_access/streaming/&apos;).on(&apos;value&apos;, (snap) =&gt; {
        const result = snap.val();
        let audience;
        if (Array.isArray(result)) {
            audience = result;
        }
        else if (typeof result === &apos;object&apos;) {
            audience = Object.values(result);
        }
        if (StreamingInstance.isStreaming()) {
            StreamingInstance.stopStreaming();
        }
        StreamingInstance = new Streaming(audience);
    }, (err) =&gt; {
        logger_1.default.error(err);
    });
};
exports.default = setUpStreamingApi;
//# sourceMappingURL=rx.js.map</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
